---
- name: Install Longhorn and Nginx Ingress Controller
  hosts: localhost
  gather_facts: false
  vars:
    kubeconfig: "{{ lookup('env', 'KUBECONFIG') | default(ansible_user_dir + '/.kube/config') }}"
    longhorn_domain: "longhorn.meiot.site"
    longhorn_namespace: "longhorn-system"
    nginx_namespace: "ingress-nginx"
    nginx_version: "4.8.0"
  
  pre_tasks:
    - name: Check kubeconfig exists
      stat:
        path: "{{ kubeconfig }}"
      register: kubeconfig_stat
      failed_when: not kubeconfig_stat.stat.exists

    - name: Verify cluster connectivity
      kubernetes.core.k8s_info:
        kind: Node
        kubeconfig: "{{ kubeconfig }}"
      register: nodes_info

    - name: Display cluster nodes
      debug:
        msg: "Cluster has {{ nodes_info.resources | length }} nodes"

  tasks:
    - name: Add Helm repositories
      kubernetes.core.helm_repository:
        name: "{{ item.name }}"
        repo_url: "{{ item.url }}"
        state: present
      loop:
        - { name: "longhorn", url: "https://charts.longhorn.io" }
        - { name: "ingress-nginx", url: "https://kubernetes.github.io/ingress-nginx" }

    - name: Create longhorn-system namespace
      kubernetes.core.k8s:
        name: "{{ longhorn_namespace }}"
        api_version: v1
        kind: Namespace
        state: present
        kubeconfig: "{{ kubeconfig }}"

    - name: Install Longhorn via Helm
      kubernetes.core.helm:
        name: longhorn
        chart_ref: longhorn/longhorn
        release_namespace: "{{ longhorn_namespace }}"
        values:
          persistence:
            defaultClassReplicaCount: 2
          csi:
            attacherReplicaCount: 2
            provisionerReplicaCount: 2
            resizerReplicaCount: 2
            snapshotterReplicaCount: 2
        state: present
        wait: true
        wait_timeout: 10m
        kubeconfig: "{{ kubeconfig }}"
      register: longhorn_install

    - name: Display Longhorn install result
      debug:
        msg: "Longhorn installed: {{ longhorn_install.status.description }}"

    - name: Create ingress-nginx namespace
      kubernetes.core.k8s:
        name: "{{ nginx_namespace }}"
        api_version: v1
        kind: Namespace
        state: present
        kubeconfig: "{{ kubeconfig }}"

    - name: Install Nginx Ingress Controller via Helm
      kubernetes.core.helm:
        name: nginx-ingress
        chart_ref: ingress-nginx/ingress-nginx
        release_namespace: "{{ nginx_namespace }}"
        version: "{{ nginx_version }}"
        values:
          controller:
            service:
              type: LoadBalancer
              externalTrafficPolicy: Local
            metrics:
              enabled: true
            podAnnotations:
              prometheus.io/scrape: "true"
              prometheus.io/port: "10254"
        state: present
        wait: true
        wait_timeout: 5m
        kubeconfig: "{{ kubeconfig }}"
      register: nginx_install

    - name: Display Nginx install result
      debug:
        msg: "Nginx Ingress installed: {{ nginx_install.status.description }}"

    - name: Wait for Nginx Ingress deployment to be ready
      kubernetes.core.k8s_info:
        kind: Deployment
        name: nginx-ingress-ingress-nginx-controller
        namespace: "{{ nginx_namespace }}"
        kubeconfig: "{{ kubeconfig }}"
      register: nginx_deployment
      until: nginx_deployment.resources[0].status.readyReplicas | default(0) > 0
      retries: 30
      delay: 10

    - name: Create Longhorn Ingress
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: longhorn-ingress
            namespace: "{{ longhorn_namespace }}"
            annotations:
              nginx.ingress.kubernetes.io/rewrite-target: /
              nginx.ingress.kubernetes.io/force-ssl-redirect: "false"
          spec:
            ingressClassName: nginx
            rules:
              - host: "{{ longhorn_domain }}"
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: longhorn-frontend
                          port:
                            number: 80
        kubeconfig: "{{ kubeconfig }}"

    - name: Get Nginx LoadBalancer service info
      kubernetes.core.k8s_info:
        kind: Service
        name: nginx-ingress-ingress-nginx-controller
        namespace: "{{ nginx_namespace }}"
        kubeconfig: "{{ kubeconfig }}"
      register: nginx_svc

    - name: Display access information
      debug:
        msg: |
          ========================================
          Installation Complete!
          ========================================
          
          Longhorn UI Domain: {{ longhorn_domain }}
          Longhorn UI URL: http://{{ longhorn_domain }}
          
          Nginx Ingress LoadBalancer Info:
          {% if nginx_svc.resources[0].status.loadBalancer.ingress is defined %}
          External IP: {{ nginx_svc.resources[0].status.loadBalancer.ingress[0].ip | default(nginx_svc.resources[0].status.loadBalancer.ingress[0].hostname) }}
          {% else %}
          (LoadBalancer IP pending - may take a few minutes)
          {% endif %}
          
          To access Longhorn UI, add this to your /etc/hosts:
          <nginx-external-ip> {{ longhorn_domain }}
          
          ========================================

  post_tasks:
    - name: Verify Longhorn pods
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ longhorn_namespace }}"
        kubeconfig: "{{ kubeconfig }}"
      register: longhorn_pods

    - name: Display Longhorn pods
      debug:
        msg: "Longhorn pods: {% for pod in longhorn_pods.resources %}{{ pod.metadata.name }} ({{ pod.status.phase }}){% if not loop.last %}, {% endif %}{% endfor %}"

    - name: Verify Nginx Ingress pods
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ nginx_namespace }}"
        kubeconfig: "{{ kubeconfig }}"
      register: nginx_pods

    - name: Display Nginx pods
      debug:
        msg: "Nginx pods: {% for pod in nginx_pods.resources %}{{ pod.metadata.name }} ({{ pod.status.phase }}){% if not loop.last %}, {% endif %}{% endfor %}"

    - name: Display Ingress status
      kubernetes.core.k8s_info:
        kind: Ingress
        name: longhorn-ingress
        namespace: "{{ longhorn_namespace }}"
        kubeconfig: "{{ kubeconfig }}"
      register: ingress_info

    - name: Show Ingress details
      debug:
        var: ingress_info.resources[0]
